<!doctype html><html lang=en><head><title>Tired of pressing F-keys rebooting your PC for an update? Let's overengineer things :: /home/angel</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Overengineering a few things to avoid pressing fkeys"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://angiglesias.github.io/posts/dual-boot-galore/><link rel=stylesheet href=/style.css><link rel=stylesheet href=https://angiglesias.github.io/overrides.css><link rel="shortcut icon" href=https://angiglesias.github.io/img/avatar_pikachu.png><meta name=twitter:card content="summary"><meta name=twitter:site content="https://twitter.com/angel_iglesias1"><meta name=twitter:creator content="angel_iglesias1"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Tired of pressing F-keys rebooting your PC for an update? Let's overengineer things"><meta property="og:description" content="Overengineering a few things to avoid pressing fkeys"><meta property="og:url" content="https://angiglesias.github.io/posts/dual-boot-galore/"><meta property="og:site_name" content="/home/angel"><meta property="og:image" content="https://angiglesias.github.io/cover.jpg"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-11-13 00:00:00 +0000 UTC"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css></head><body class=teal><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo><span class=logo-text>[angel@indigo2]$</span>
<span class=logo-cursor></span></div></a></div><div class=menu-trigger>menu</div></div><nav class="menu hidden-on-mobile"><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://angiglesias.github.io/posts/dual-boot-galore/>Tired of pressing F-keys rebooting your PC for an update? Let&rsquo;s overengineer things</a></h1><div class=post-meta><time class=post-date>2022-11-13 ::</time>
<span class=post-author>Angel</span>
<span class=post-reading-time>:: 5 min read (1032 words)</span></div><span class=post-tags>#<a href=https://angiglesias.github.io/tags/linux/>linux</a>&nbsp;
#<a href=https://angiglesias.github.io/tags/sysadmin/>sysadmin</a>&nbsp;
#<a href=https://angiglesias.github.io/tags/dual-boot/>dual-boot</a>&nbsp;
#<a href=https://angiglesias.github.io/tags/systemd/>systemd</a>&nbsp;</span>
<img src=/posts/dual-boot-galore/cover.jpg class=post-cover alt="Tired of pressing F-keys rebooting your PC for an update? Let's overengineer things" title="Cover Image"><div class=post-content><div><h1 id=dual-booting-with-windows-without-renoucing-to-secure-boot-_et-al_>Dual booting with Windows without renoucing to secure boot <em>et al</em><a href=#dual-booting-with-windows-without-renoucing-to-secure-boot-_et-al_ class=hanchor arialabel=Anchor>&#8983;</a></h1><p>This would have been easier by disabling secure boot on bios settings and calling it a day. But I wanted to keep bitlocker disk encryption and boot assurance using the tpm chip on my motherboard. Combining these settings, there&rsquo;s only one way to boot Windows witHout ending in a recovering screen asking for your recovery key: booting in UEFI to the windows boot manager. If you try to select Windows from Grub, you&rsquo;ll be greeted with a cyan screen asking for your recovery password.</p><p>Let&rsquo;s say you usually boot to windows because some program (or game) you usually use is only available for that OS, so you kept Windows as the default boot option. This left booting Linux to the f-key pressing ritual to select the correct boot option. On the bright side, managing the windows update thingie won&rsquo;t require pressing again f-keys to boot back again.</p><h1 id=introducing-linux-offline-updates>Introducing Linux offline updates<a href=#introducing-linux-offline-updates class=hanchor arialabel=Anchor>&#8983;</a></h1><p>I&rsquo;ve using Fedora Linux on my work laptop for two years and loving the experience, but kept my desktop running KDE Neon (Ubuntu-based) because the nvidia gpu was <em>kinda problematic</em> with the Wayland display manager. <a href=https://www.phoronix.com/news/NVIDIA-470-Wayland-Friendly>This began to change in 2021</a> and nowadays, is more than feasible running a Wayland compositor on your nvidia gpu (yours truly wrote this on Fedora 36 running on an rtx30 series gpu).</p><p>Fedora upgrades are managed by pkgkit&rsquo;s offline upgrades system by default. After looking under the hood of the upgrade system, this method is enabled by the systemd upgrading system as follows:</p><ul><li>Pkgkit downloads the updates to apply to your computer.</li><li>Pkgkit signals the availability of new updates to systemd (in our case, by establishing a symlink to the update directory in <code>/system-update</code>).</li><li>After a reboot, systemd boots to the system-update target and runs the upgrade service(s) available to apply updates.</li><li>After finishing the upgrade, systemd will reboot to the default boot target (in our case, graphical.target)</li></ul><p>In the setup described before, updating Fedora and carrying on means two f-key cycles and supervision of the update, at the least, to start the update in the first reboot selecting the Linux boot target. This can be reduced to one f-key cycle with the help of <code>efibootmgr</code>. UEFI has the var <code>bootnext</code> which allows setting which boot target to load on the next reboot. For example, on my desktop:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>angel@indigo2 ~<span style=color:#f92672>]</span>$ efibootmgr
</span></span><span style=display:flex><span>BootCurrent: <span style=color:#ae81ff>0004</span>
</span></span><span style=display:flex><span>Timeout: <span style=color:#ae81ff>1</span> seconds
</span></span><span style=display:flex><span>BootOrder: 0000,0004
</span></span><span style=display:flex><span>Boot0000* Windows Boot Manager
</span></span><span style=display:flex><span>Boot0004* Fedora
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Usage</span>
</span></span><span style=display:flex><span>usage: efibootmgr <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>	-a | --active         sets bootnum active
</span></span><span style=display:flex><span>	-A | --inactive       sets bootnum inactive
</span></span><span style=display:flex><span>	-b | --bootnum XXXX   modify BootXXXX <span style=color:#f92672>(</span>hex<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	-B | --delete-bootnum delete bootnum
</span></span><span style=display:flex><span>	-c | --create         create new variable bootnum and add to bootorder
</span></span><span style=display:flex><span>	-C | --create-only	create new variable bootnum and <span style=color:#66d9ef>do</span> not add to bootorder
</span></span><span style=display:flex><span>	-D | --remove-dups	remove duplicate values from BootOrder
</span></span><span style=display:flex><span>	-d | --disk disk       <span style=color:#f92672>(</span>defaults to /dev/sda<span style=color:#f92672>)</span> containing loader
</span></span><span style=display:flex><span>	-r | --driver         Operate on Driver variables, not Boot Variables.
</span></span><span style=display:flex><span>	-e | --edd <span style=color:#f92672>[</span>1|3|-1<span style=color:#f92672>]</span>   force EDD 1.0 or 3.0 creation variables, or guess
</span></span><span style=display:flex><span>	-E | --device num      EDD 1.0 device number <span style=color:#f92672>(</span>defaults to 0x80<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	-g | --gpt            force disk with invalid PMBR to be treated as GPT
</span></span><span style=display:flex><span>	-i | --iface name     create a netboot entry <span style=color:#66d9ef>for</span> the named interface
</span></span><span style=display:flex><span>	-l | --loader name     <span style=color:#f92672>(</span>defaults to <span style=color:#e6db74>&#34;\EFI\fedora\grub.efi&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	-L | --label label     Boot manager display label <span style=color:#f92672>(</span>defaults to <span style=color:#e6db74>&#34;Linux&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	-m | --mirror-below-4G t|f mirror memory below 4GB
</span></span><span style=display:flex><span>	-M | --mirror-above-4G X percentage memory to mirror above 4GB
</span></span><span style=display:flex><span>	-n | --bootnext XXXX   set BootNext to XXXX <span style=color:#f92672>(</span>hex<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	-N | --delete-bootnext delete BootNext
</span></span><span style=display:flex><span>	-o | --bootorder XXXX,YYYY,ZZZZ,...     explicitly set BootOrder <span style=color:#f92672>(</span>hex<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	-O | --delete-bootorder delete BootOrder
</span></span><span style=display:flex><span>	-p | --part part        <span style=color:#f92672>(</span>defaults to 1<span style=color:#f92672>)</span> containing loader
</span></span><span style=display:flex><span>	-q | --quiet            be quiet
</span></span><span style=display:flex><span>	-t | --timeout seconds  set boot manager timeout waiting <span style=color:#66d9ef>for</span> user input.
</span></span><span style=display:flex><span>	-T | --delete-timeout   delete Timeout.
</span></span><span style=display:flex><span>	-u | --unicode | --UCS-2  handle extra args as UCS-2 <span style=color:#f92672>(</span>default is ASCII<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	-v | --verbose          print additional information
</span></span><span style=display:flex><span>	-V | --version          <span style=color:#66d9ef>return</span> version and exit
</span></span><span style=display:flex><span>	-w | --write-signature  write unique sig to MBR <span style=color:#66d9ef>if</span> needed
</span></span><span style=display:flex><span>	-y | --sysprep          Operate on SysPrep variables, not Boot Variables.
</span></span><span style=display:flex><span>	-@ | --append-binary-args file  append extra args from file <span style=color:#f92672>(</span>use <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#66d9ef>for</span> stdin<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	-h | --help             show help/usage
</span></span></code></pre></div><p>With <code>efibootmgr -n 0004</code> Fedora is selected as the default boot target on the next reboot. Keeping this in mind, it seems like with this trick we can automate the update process to avoid pressing f-whatever on the next reboot to choose Linux.</p><h1 id=systemd-probable-cause-and-solution-for-all-problems>Systemd, (probable) cause and solution for all problems<a href=#systemd-probable-cause-and-solution-for-all-problems class=hanchor arialabel=Anchor>&#8983;</a></h1><p>The first thing that comes to mind is using systemd services to set the nextboot efivar to reload Linux again after a reboot, as it is at the heart of the upgrade system.</p><p>With the previously discussed information in mind, it&rsquo;s easy to write a service to set the efivar when the system is rebooted and an upgrade is ready to apply:</p><pre tabindex=0><code class=language-conf data-lang=conf>[Unit]
Description=Set UEFI bootnext to reload again linux when an offline upgrade is ready
DefaultDependencies=no
Before=shutdown.target
ConditionPathExists=/system-update

[Service]
Type=oneshot
ExecStart=/usr/local/bin/set-nextboot-to-current

[Install]
WantedBy=shutdown.target
</code></pre><p>The most important things here are:</p><ul><li>The condition <code>ConditionPathExists=/system-update</code> means the service is only executed when a system upgrade is signaled available to systemd.</li><li>The dependencies with the target <code>shutdown</code> which set this service execution only happen when the system is being switched off.</li></ul><p>On the other hand, booting back to Linux after the upgrade is finished, needs a little more consideration, as the system will reach the <code>reboot</code> target after successfully finishing the <code>system-update</code> one:</p><pre tabindex=0><code class=language-conf data-lang=conf>[Unit]
Description=Set UEFI nextboot to fedora after an system offline upgrade
DefaultDependencies=no
Requisite=system-update.target
After=system-update.target
Before=reboot.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/set-nextboot-to-current

[Install]
WantedBy=reboot.target
</code></pre><p>The most important things in this case are:</p><ul><li>The dependencies <code>Requisite=system-update.target</code> and <code>After=system-update.target</code> restrict the service execution only if <code>system-update</code> target was reached successfully.</li><li>The dependencies with the <code>reboot</code> target restrict the service execution only when the computer will be restarted.</li></ul><p>In both cases, the script <code>set-nextboot-to-current</code> is a simple bash script recovering the current booted target and setting UEFI&rsquo;s nextboot var:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>set -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>efibootmgr | grep <span style=color:#e6db74>&#34;BootCurrent&#34;</span> | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span> | xargs -I <span style=color:#f92672>{}</span> efibootmgr -n <span style=color:#f92672>{}</span>
</span></span></code></pre></div><p>So that&rsquo;s it, a little bit of overengineering to avoid pressing f-something a keeping an eye on while the PC is updating.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://angiglesias.github.io/posts/bmp388/><span class=button__text>Playing around with a BMP388 or my first Linux Kernel contribution</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script><footer class=social-footer><div class=social-footer-icons><a href=https://github.com/angiglesias title="Github profile" target=_blank rel="noopener noreferrer"><i class="fa fa-github" aria-hidden=true></i></a>
<a href=https://es.linkedin.com/in/%C3%A1ngel-iglesias-garc%C3%ADa-bb3020141/en title="LinkedIn profile" target=_blank rel="noopener noreferrer"><i class="fa fa-linkedin" aria-hidden=true></i></a></div></footer></div></body></html>